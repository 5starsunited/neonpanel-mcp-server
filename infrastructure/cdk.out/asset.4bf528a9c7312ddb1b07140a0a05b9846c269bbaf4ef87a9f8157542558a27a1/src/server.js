"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const cors_1 = __importDefault(require("cors"));
const axios_1 = __importDefault(require("axios"));
const zod_1 = require("zod");
const app = (0, express_1.default)();
app.use((0, cors_1.default)());
app.use(express_1.default.json());
const NEONPANEL_BASE_URL = process.env.NEONPANEL_BASE_URL || 'https://my.neonpanel.com';
const KEEPA_MCP_BASE_URL = process.env.KEEPA_MCP_BASE_URL || '';
// Health
app.get('/health', (_req, res) => {
    res.json({ status: 'ok', service: 'neonpanel-mcp', baseUrl: NEONPANEL_BASE_URL, ts: new Date().toISOString() });
});
// Input for /exec
const ExecSchema = zod_1.z.object({
    action: zod_1.z.string().min(1),
    args: zod_1.z.record(zod_1.z.any()).default({})
});
// NeonPanel schemas (subsets aligned to docs/capabilities/neonpanel.yaml)
const CompanyUuid = zod_1.z.string().min(1);
const GetItemsSchema = zod_1.z.object({
    companyUuid: CompanyUuid,
    page: zod_1.z.number().int().min(1).optional(),
    per_page: zod_1.z.number().int().min(10).max(60).optional(),
    country_code: zod_1.z.string().length(2).optional(),
    search: zod_1.z.string().optional(),
    fnsku: zod_1.z.string().optional(),
    asin: zod_1.z.string().optional(),
    sku: zod_1.z.string().optional(),
});
const CommonItemPathSchema = zod_1.z.object({
    companyUuid: CompanyUuid,
    inventoryId: zod_1.z.number().int().nonnegative(),
});
const DateRangeSchema = zod_1.z.object({
    warehouse_uuid: zod_1.z.string().min(1),
    start_date: zod_1.z.string().min(1),
    end_date: zod_1.z.string().optional(),
});
const RevenueAndCogsSchema = zod_1.z.object({
    company_uuids: zod_1.z.array(zod_1.z.string()).optional(),
    country_codes: zod_1.z.array(zod_1.z.string()).optional(),
    grouping: zod_1.z.array(zod_1.z.enum(['company', 'country', 'invoice'])).optional(),
    periodicity: zod_1.z.enum(['total', 'day', 'week', 'month', 'quarter', 'year']).optional(),
    start_date: zod_1.z.string().optional(),
    end_date: zod_1.z.string().optional(),
});
function buildQuery(obj) {
    const params = new URLSearchParams();
    for (const [k, v] of Object.entries(obj)) {
        if (v === undefined || v === null)
            continue;
        if (Array.isArray(v)) {
            for (const item of v)
                params.append(`${k}[]`, String(item));
        }
        else {
            params.append(k, String(v));
        }
    }
    const qs = params.toString();
    return qs ? `?${qs}` : '';
}
async function neonpanelGet(path, token) {
    const url = `${NEONPANEL_BASE_URL}${path}`;
    const res = await axios_1.default.get(url, { headers: { Authorization: token, 'Accept': 'application/json' } });
    return res.data;
}
app.post('/exec', async (req, res) => {
    try {
        const auth = req.headers['authorization'];
        if (!auth || !auth.toString().toLowerCase().startsWith('bearer ')) {
            return res.status(401).json({ ok: false, message: 'Missing Authorization bearer token' });
        }
        const { action, args } = ExecSchema.parse(req.body || {});
        const [provider] = action.split('.');
        let data;
        switch (action) {
            case 'neonpanel.inventoryManager.getItems': {
                const p = GetItemsSchema.parse(args || {});
                const { companyUuid, ...rest } = p;
                const qs = buildQuery(rest);
                data = await neonpanelGet(`/api/v1/companies/${encodeURIComponent(companyUuid)}/inventory-items${qs}`, auth);
                break;
            }
            case 'neonpanel.inventoryManager.getItemCogs': {
                const p = CommonItemPathSchema.and(DateRangeSchema).parse(args || {});
                const { companyUuid, inventoryId, ...rest } = p;
                const qs = buildQuery(rest);
                data = await neonpanelGet(`/api/v1/companies/${encodeURIComponent(companyUuid)}/inventory-items/${encodeURIComponent(String(inventoryId))}/cogs${qs}`, auth);
                break;
            }
            case 'neonpanel.inventoryManager.getItemLandedCost': {
                const p = CommonItemPathSchema.and(DateRangeSchema).parse(args || {});
                const { companyUuid, inventoryId, ...rest } = p;
                const qs = buildQuery(rest);
                data = await neonpanelGet(`/api/v1/companies/${encodeURIComponent(companyUuid)}/inventory-items/${encodeURIComponent(String(inventoryId))}/landed-cost${qs}`, auth);
                break;
            }
            case 'neonpanel.finance.revenueAndCogs': {
                const p = RevenueAndCogsSchema.parse(args || {});
                const qs = buildQuery(p);
                data = await neonpanelGet(`/api/v1/revenue-and-cogs${qs}`, auth);
                break;
            }
            case 'keepa.marketingResearch.productLookup': {
                if (!KEEPA_MCP_BASE_URL)
                    return res.status(400).json({ ok: false, message: 'KEEPA_MCP_BASE_URL not configured' });
                const KeepaLookupSchema = zod_1.z.object({ asin: zod_1.z.string().min(1), domain: zod_1.z.number().int().min(1).max(11).default(1) });
                const p = KeepaLookupSchema.parse(args || {});
                // Use bearer token as Keepa apiKey
                const apiKey = auth.replace(/^Bearer\s+/i, '');
                const url = `${KEEPA_MCP_BASE_URL.replace(/\/$/, '')}/api/keepa/product-lookup`;
                const r = await axios_1.default.post(url, { apiKey, ...p }, { headers: { 'Content-Type': 'application/json' } });
                data = r.data;
                break;
            }
            case 'keepa.marketingResearch.priceHistory': {
                if (!KEEPA_MCP_BASE_URL)
                    return res.status(400).json({ ok: false, message: 'KEEPA_MCP_BASE_URL not configured' });
                const KeepaPriceSchema = zod_1.z.object({ asin: zod_1.z.string().min(1), domain: zod_1.z.number().int().min(1).max(11).default(1), days: zod_1.z.number().int().min(1).max(365).optional() });
                const p = KeepaPriceSchema.parse(args || {});
                const apiKey = auth.replace(/^Bearer\s+/i, '');
                const url = `${KEEPA_MCP_BASE_URL.replace(/\/$/, '')}/api/keepa/price-history`;
                const r = await axios_1.default.post(url, { apiKey, ...p }, { headers: { 'Content-Type': 'application/json' } });
                data = r.data;
                break;
            }
            default:
                return res.status(400).json({ ok: false, message: `Unknown or unsupported action '${action}'` });
        }
        res.json({ ok: true, data });
    }
    catch (e) {
        const status = e?.response?.status || 500;
        const message = e?.response?.data || e?.message || 'Internal error';
        res.status(status).json({ ok: false, message });
    }
});
const PORT = process.env.PORT || 3030;
if (require.main === module) {
    app.listen(PORT, () => {
        console.log(`NeonPanel MCP HTTP server running on :${PORT}`);
        console.log(`Health: http://localhost:${PORT}/health`);
        console.log(`Exec:   POST http://localhost:${PORT}/exec { action, args } (Authorization: Bearer <token>)`);
    });
}
exports.default = app;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQThCO0FBQzlCLGdEQUF3QjtBQUN4QixrREFBMEI7QUFDMUIsNkJBQXdCO0FBRXhCLE1BQU0sR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO0FBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBQSxjQUFJLEdBQUUsQ0FBQyxDQUFDO0FBQ2hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBRXhCLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSwwQkFBMEIsQ0FBQztBQUN4RixNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBRWhFLFNBQVM7QUFDVCxHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUMvQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDbEgsQ0FBQyxDQUFDLENBQUM7QUFFSCxrQkFBa0I7QUFDbEIsTUFBTSxVQUFVLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMxQixNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekIsSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLENBQUMsT0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztDQUNwQyxDQUFDLENBQUM7QUFFSCww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ZixNQUFNLE1BQU0sR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sSUFBSSxHQUFHLENBQUM7UUFDMUMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLElBQUksQ0FBQyxFQUFFLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQztRQUNwRSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztLQUNqRDtBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDO0FBQ3RDLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7SUFDM0IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFO1FBQ3BCLE9BQU8sQ0FBQyxHQUFHLENBQUMseUNBQXlDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDN0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsSUFBSSxTQUFTLENBQUMsQ0FBQztRQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxJQUFJLHdEQUF3RCxDQUFDLENBQUM7SUFDN0csQ0FBQyxDQUFDLENBQUM7Q0FDSjtBQUVELGtCQUFlLEdBQUcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGNvcnMgZnJvbSAnY29ycyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5cbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbmFwcC51c2UoY29ycygpKTtcbmFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xuXG5jb25zdCBORU9OUEFORUxfQkFTRV9VUkwgPSBwcm9jZXNzLmVudi5ORU9OUEFORUxfQkFTRV9VUkwgfHwgJ2h0dHBzOi8vbXkubmVvbnBhbmVsLmNvbSc7XG5jb25zdCBLRUVQQV9NQ1BfQkFTRV9VUkwgPSBwcm9jZXNzLmVudi5LRUVQQV9NQ1BfQkFTRV9VUkwgfHwgJyc7XG5cbi8vIEhlYWx0aFxuYXBwLmdldCgnL2hlYWx0aCcsIChfcmVxLCByZXMpID0+IHtcbiAgcmVzLmpzb24oeyBzdGF0dXM6ICdvaycsIHNlcnZpY2U6ICduZW9ucGFuZWwtbWNwJywgYmFzZVVybDogTkVPTlBBTkVMX0JBU0VfVVJMLCB0czogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH0pO1xufSk7XG5cbi8vIElucHV0IGZvciAvZXhlY1xuY29uc3QgRXhlY1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgYWN0aW9uOiB6LnN0cmluZygpLm1pbigxKSxcbiAgYXJnczogei5yZWNvcmQoei5hbnkoKSkuZGVmYXVsdCh7fSlcbn0pO1xuXG4vLyBOZW9uUGFuZWwgc2NoZW1hcyAoc3Vic2V0cyBhbGlnbmVkIHRvIGRvY3MvY2FwYWJpbGl0aWVzL25lb25wYW5lbC55YW1sKVxuY29uc3QgQ29tcGFueVV1aWQgPSB6LnN0cmluZygpLm1pbigxKTtcblxuY29uc3QgR2V0SXRlbXNTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGNvbXBhbnlVdWlkOiBDb21wYW55VXVpZCxcbiAgcGFnZTogei5udW1iZXIoKS5pbnQoKS5taW4oMSkub3B0aW9uYWwoKSxcbiAgcGVyX3BhZ2U6IHoubnVtYmVyKCkuaW50KCkubWluKDEwKS5tYXgoNjApLm9wdGlvbmFsKCksXG4gIGNvdW50cnlfY29kZTogei5zdHJpbmcoKS5sZW5ndGgoMikub3B0aW9uYWwoKSxcbiAgc2VhcmNoOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGZuc2t1OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGFzaW46IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgc2t1OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgQ29tbW9uSXRlbVBhdGhTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGNvbXBhbnlVdWlkOiBDb21wYW55VXVpZCxcbiAgaW52ZW50b3J5SWQ6IHoubnVtYmVyKCkuaW50KCkubm9ubmVnYXRpdmUoKSxcbn0pO1xuXG5jb25zdCBEYXRlUmFuZ2VTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHdhcmVob3VzZV91dWlkOiB6LnN0cmluZygpLm1pbigxKSxcbiAgc3RhcnRfZGF0ZTogei5zdHJpbmcoKS5taW4oMSksXG4gIGVuZF9kYXRlOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgUmV2ZW51ZUFuZENvZ3NTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGNvbXBhbnlfdXVpZHM6IHouYXJyYXkoei5zdHJpbmcoKSkub3B0aW9uYWwoKSxcbiAgY291bnRyeV9jb2Rlczogei5hcnJheSh6LnN0cmluZygpKS5vcHRpb25hbCgpLFxuICBncm91cGluZzogei5hcnJheSh6LmVudW0oWydjb21wYW55JywnY291bnRyeScsJ2ludm9pY2UnXSkpLm9wdGlvbmFsKCksXG4gIHBlcmlvZGljaXR5OiB6LmVudW0oWyd0b3RhbCcsJ2RheScsJ3dlZWsnLCdtb250aCcsJ3F1YXJ0ZXInLCd5ZWFyJ10pLm9wdGlvbmFsKCksXG4gIHN0YXJ0X2RhdGU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgZW5kX2RhdGU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbn0pO1xuXG5mdW5jdGlvbiBidWlsZFF1ZXJ5KG9iajogUmVjb3JkPHN0cmluZywgYW55Pikge1xuICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XG4gIGZvciAoY29uc3QgW2ssIHZdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHtcbiAgICBpZiAodiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGwpIGNvbnRpbnVlO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHYpKSB7XG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdikgcGFyYW1zLmFwcGVuZChgJHtrfVtdYCwgU3RyaW5nKGl0ZW0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zLmFwcGVuZChrLCBTdHJpbmcodikpO1xuICAgIH1cbiAgfVxuICBjb25zdCBxcyA9IHBhcmFtcy50b1N0cmluZygpO1xuICByZXR1cm4gcXMgPyBgPyR7cXN9YCA6ICcnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBuZW9ucGFuZWxHZXQocGF0aDogc3RyaW5nLCB0b2tlbjogc3RyaW5nKSB7XG4gIGNvbnN0IHVybCA9IGAke05FT05QQU5FTF9CQVNFX1VSTH0ke3BhdGh9YDtcbiAgY29uc3QgcmVzID0gYXdhaXQgYXhpb3MuZ2V0KHVybCwgeyBoZWFkZXJzOiB7IEF1dGhvcml6YXRpb246IHRva2VuLCAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nIH0gfSk7XG4gIHJldHVybiByZXMuZGF0YTtcbn1cblxuYXBwLnBvc3QoJy9leGVjJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgYXV0aCA9IHJlcS5oZWFkZXJzWydhdXRob3JpemF0aW9uJ107XG4gICAgaWYgKCFhdXRoIHx8ICFhdXRoLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCdiZWFyZXIgJykpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IG9rOiBmYWxzZSwgbWVzc2FnZTogJ01pc3NpbmcgQXV0aG9yaXphdGlvbiBiZWFyZXIgdG9rZW4nIH0pO1xuICAgIH1cbiAgICBjb25zdCB7IGFjdGlvbiwgYXJncyB9ID0gRXhlY1NjaGVtYS5wYXJzZShyZXEuYm9keSB8fCB7fSk7XG5cbiAgICBjb25zdCBbcHJvdmlkZXJdID0gYWN0aW9uLnNwbGl0KCcuJykgYXMgW3N0cmluZywgLi4uc3RyaW5nW11dO1xuXG4gICAgbGV0IGRhdGE6IGFueTtcbiAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgY2FzZSAnbmVvbnBhbmVsLmludmVudG9yeU1hbmFnZXIuZ2V0SXRlbXMnOiB7XG4gICAgICAgIGNvbnN0IHAgPSBHZXRJdGVtc1NjaGVtYS5wYXJzZShhcmdzIHx8IHt9KTtcbiAgICAgICAgY29uc3QgeyBjb21wYW55VXVpZCwgLi4ucmVzdCB9ID0gcDtcbiAgICAgICAgY29uc3QgcXMgPSBidWlsZFF1ZXJ5KHJlc3QgYXMgYW55KTtcbiAgICAgICAgZGF0YSA9IGF3YWl0IG5lb25wYW5lbEdldChgL2FwaS92MS9jb21wYW5pZXMvJHtlbmNvZGVVUklDb21wb25lbnQoY29tcGFueVV1aWQpfS9pbnZlbnRvcnktaXRlbXMke3FzfWAsIGF1dGggYXMgc3RyaW5nKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICduZW9ucGFuZWwuaW52ZW50b3J5TWFuYWdlci5nZXRJdGVtQ29ncyc6IHtcbiAgICAgICAgY29uc3QgcCA9IENvbW1vbkl0ZW1QYXRoU2NoZW1hLmFuZChEYXRlUmFuZ2VTY2hlbWEpLnBhcnNlKGFyZ3MgfHwge30pO1xuICAgICAgICBjb25zdCB7IGNvbXBhbnlVdWlkLCBpbnZlbnRvcnlJZCwgLi4ucmVzdCB9ID0gcCBhcyBhbnk7XG4gICAgICAgIGNvbnN0IHFzID0gYnVpbGRRdWVyeShyZXN0KTtcbiAgICAgICAgZGF0YSA9IGF3YWl0IG5lb25wYW5lbEdldChgL2FwaS92MS9jb21wYW5pZXMvJHtlbmNvZGVVUklDb21wb25lbnQoY29tcGFueVV1aWQpfS9pbnZlbnRvcnktaXRlbXMvJHtlbmNvZGVVUklDb21wb25lbnQoU3RyaW5nKGludmVudG9yeUlkKSl9L2NvZ3Mke3FzfWAsIGF1dGggYXMgc3RyaW5nKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICduZW9ucGFuZWwuaW52ZW50b3J5TWFuYWdlci5nZXRJdGVtTGFuZGVkQ29zdCc6IHtcbiAgICAgICAgY29uc3QgcCA9IENvbW1vbkl0ZW1QYXRoU2NoZW1hLmFuZChEYXRlUmFuZ2VTY2hlbWEpLnBhcnNlKGFyZ3MgfHwge30pO1xuICAgICAgICBjb25zdCB7IGNvbXBhbnlVdWlkLCBpbnZlbnRvcnlJZCwgLi4ucmVzdCB9ID0gcCBhcyBhbnk7XG4gICAgICAgIGNvbnN0IHFzID0gYnVpbGRRdWVyeShyZXN0KTtcbiAgICAgICAgZGF0YSA9IGF3YWl0IG5lb25wYW5lbEdldChgL2FwaS92MS9jb21wYW5pZXMvJHtlbmNvZGVVUklDb21wb25lbnQoY29tcGFueVV1aWQpfS9pbnZlbnRvcnktaXRlbXMvJHtlbmNvZGVVUklDb21wb25lbnQoU3RyaW5nKGludmVudG9yeUlkKSl9L2xhbmRlZC1jb3N0JHtxc31gLCBhdXRoIGFzIHN0cmluZyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAnbmVvbnBhbmVsLmZpbmFuY2UucmV2ZW51ZUFuZENvZ3MnOiB7XG4gICAgICAgIGNvbnN0IHAgPSBSZXZlbnVlQW5kQ29nc1NjaGVtYS5wYXJzZShhcmdzIHx8IHt9KTtcbiAgICAgICAgY29uc3QgcXMgPSBidWlsZFF1ZXJ5KHAgYXMgYW55KTtcbiAgICAgICAgZGF0YSA9IGF3YWl0IG5lb25wYW5lbEdldChgL2FwaS92MS9yZXZlbnVlLWFuZC1jb2dzJHtxc31gLCBhdXRoIGFzIHN0cmluZyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAna2VlcGEubWFya2V0aW5nUmVzZWFyY2gucHJvZHVjdExvb2t1cCc6IHtcbiAgICAgICAgaWYgKCFLRUVQQV9NQ1BfQkFTRV9VUkwpIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG9rOiBmYWxzZSwgbWVzc2FnZTogJ0tFRVBBX01DUF9CQVNFX1VSTCBub3QgY29uZmlndXJlZCcgfSk7XG4gICAgICAgIGNvbnN0IEtlZXBhTG9va3VwU2NoZW1hID0gei5vYmplY3QoeyBhc2luOiB6LnN0cmluZygpLm1pbigxKSwgZG9tYWluOiB6Lm51bWJlcigpLmludCgpLm1pbigxKS5tYXgoMTEpLmRlZmF1bHQoMSkgfSk7XG4gICAgICAgIGNvbnN0IHAgPSBLZWVwYUxvb2t1cFNjaGVtYS5wYXJzZShhcmdzIHx8IHt9KTtcbiAgICAgICAgLy8gVXNlIGJlYXJlciB0b2tlbiBhcyBLZWVwYSBhcGlLZXlcbiAgICAgICAgY29uc3QgYXBpS2V5ID0gKGF1dGggYXMgc3RyaW5nKS5yZXBsYWNlKC9eQmVhcmVyXFxzKy9pLCAnJyk7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke0tFRVBBX01DUF9CQVNFX1VSTC5yZXBsYWNlKC9cXC8kLywgJycpfS9hcGkva2VlcGEvcHJvZHVjdC1sb29rdXBgO1xuICAgICAgICBjb25zdCByID0gYXdhaXQgYXhpb3MucG9zdCh1cmwsIHsgYXBpS2V5LCAuLi5wIH0sIHsgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0gfSk7XG4gICAgICAgIGRhdGEgPSByLmRhdGE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAna2VlcGEubWFya2V0aW5nUmVzZWFyY2gucHJpY2VIaXN0b3J5Jzoge1xuICAgICAgICBpZiAoIUtFRVBBX01DUF9CQVNFX1VSTCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgb2s6IGZhbHNlLCBtZXNzYWdlOiAnS0VFUEFfTUNQX0JBU0VfVVJMIG5vdCBjb25maWd1cmVkJyB9KTtcbiAgICAgICAgY29uc3QgS2VlcGFQcmljZVNjaGVtYSA9IHoub2JqZWN0KHsgYXNpbjogei5zdHJpbmcoKS5taW4oMSksIGRvbWFpbjogei5udW1iZXIoKS5pbnQoKS5taW4oMSkubWF4KDExKS5kZWZhdWx0KDEpLCBkYXlzOiB6Lm51bWJlcigpLmludCgpLm1pbigxKS5tYXgoMzY1KS5vcHRpb25hbCgpIH0pO1xuICAgICAgICBjb25zdCBwID0gS2VlcGFQcmljZVNjaGVtYS5wYXJzZShhcmdzIHx8IHt9KTtcbiAgICAgICAgY29uc3QgYXBpS2V5ID0gKGF1dGggYXMgc3RyaW5nKS5yZXBsYWNlKC9eQmVhcmVyXFxzKy9pLCAnJyk7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke0tFRVBBX01DUF9CQVNFX1VSTC5yZXBsYWNlKC9cXC8kLywgJycpfS9hcGkva2VlcGEvcHJpY2UtaGlzdG9yeWA7XG4gICAgICAgIGNvbnN0IHIgPSBhd2FpdCBheGlvcy5wb3N0KHVybCwgeyBhcGlLZXksIC4uLnAgfSwgeyBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSB9KTtcbiAgICAgICAgZGF0YSA9IHIuZGF0YTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBvazogZmFsc2UsIG1lc3NhZ2U6IGBVbmtub3duIG9yIHVuc3VwcG9ydGVkIGFjdGlvbiAnJHthY3Rpb259J2AgfSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oeyBvazogdHJ1ZSwgZGF0YSB9KTtcbiAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgY29uc3Qgc3RhdHVzID0gZT8ucmVzcG9uc2U/LnN0YXR1cyB8fCA1MDA7XG4gICAgY29uc3QgbWVzc2FnZSA9IGU/LnJlc3BvbnNlPy5kYXRhIHx8IGU/Lm1lc3NhZ2UgfHwgJ0ludGVybmFsIGVycm9yJztcbiAgICByZXMuc3RhdHVzKHN0YXR1cykuanNvbih7IG9rOiBmYWxzZSwgbWVzc2FnZSB9KTtcbiAgfVxufSk7XG5cbmNvbnN0IFBPUlQgPSBwcm9jZXNzLmVudi5QT1JUIHx8IDMwMzA7XG5pZiAocmVxdWlyZS5tYWluID09PSBtb2R1bGUpIHtcbiAgYXBwLmxpc3RlbihQT1JULCAoKSA9PiB7XG4gICAgY29uc29sZS5sb2coYE5lb25QYW5lbCBNQ1AgSFRUUCBzZXJ2ZXIgcnVubmluZyBvbiA6JHtQT1JUfWApO1xuICAgIGNvbnNvbGUubG9nKGBIZWFsdGg6IGh0dHA6Ly9sb2NhbGhvc3Q6JHtQT1JUfS9oZWFsdGhgKTtcbiAgICBjb25zb2xlLmxvZyhgRXhlYzogICBQT1NUIGh0dHA6Ly9sb2NhbGhvc3Q6JHtQT1JUfS9leGVjIHsgYWN0aW9uLCBhcmdzIH0gKEF1dGhvcml6YXRpb246IEJlYXJlciA8dG9rZW4+KWApO1xuICB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXBwO1xuIl19