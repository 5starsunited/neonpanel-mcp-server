{
  "name": "supply_chain_shipment_arrival_oracle",
  "description": "Monitor in-transit shipments with predictive ETAs based on historical warehouse-to-warehouse performance.\n\nThis tool provides real-time visibility into shipment status with:\n- Statistical ETA predictions: P50 (median), P80 (conservative), P95 (worst-case) arrival dates\n- Delay detection: Compare carrier-provided ETAs against historical route performance\n- Ghost shipment identification: Detect shipments physically arrived but not ledger-received\n- Route performance insights: Identify consistently slow/fast shipping lanes\n- Urgency scoring: Prioritize which shipments need immediate attention\n- Route aggregation mode: Analyze performance by shipping lane\n\nMODES:\n1. SHIPMENT MODE (default): Returns individual shipment details\n2. ROUTE AGGREGATION MODE: Set aggregate_by_route=true to get performance by origin→destination pairs\n\nDATA SOURCE:\n- Table: neonpanel_iceberg.inventory_shipments_snapshot\n- Coverage: All shipment types (warehouse-to-warehouse, FBA inbound, AWD inbound)\n- Updates: Daily refresh with latest tracking data\n\nDEFAULT FILTERS (applied automatically):\n- Excludes terminal statuses: CLOSED, CANCELLED, DELETED, ERROR (use include_terminal_status=true to override)\n- Excludes received shipments: Only shows in-transit (use include_received=true to override)\n- When using search or ref_number: Terminal status filter is automatically disabled to find any shipment\n\nSTATISTICAL ETA CALCULATION:\n- p50_eta: Median arrival date (50th percentile) - expected arrival under normal conditions\n- p80_eta: Conservative estimate (80th percentile) - accounts for typical delays\n- p95_eta: Worst-case estimate (95th percentile) - accounts for severe delays\n- has_historical_data: TRUE if route has historical performance data, FALSE if new route\n\nURGENCY SCORE (0-100):\n- 100: Ghost shipment (arrived but not received - highest priority)\n- 50-99: Severely delayed or stuck in transit\n- 15-49: Moderately delayed or long transit time\n- 0-14: On track, no action needed\n\nSHIPMENT TYPES (shipment_type field - logistics model):\n- 'REGULAR': Standard warehouse-to-warehouse transfers\n- 'FBA INBOUND': Shipments to Amazon FBA fulfillment centers\n- 'AWD INBOUND': Shipments to Amazon Warehousing & Distribution\n\nSHIPMENT STATUS (shipment_status field - workflow stage):\n- CREATED, WORKING, READY_TO_SHIP, SHIPPED, IN_TRANSIT, DELIVERED, CHECKED_IN, RECEIVING, CLOSED, CANCELLED, DELETED, ERROR\n\nSIGNALS (Actionable Alerts) - Can be used as filters:\n- 'Ghost Shipment': Physically arrived (arrived_at set) but not received in ledger\n- 'Delayed': Carrier ETA exceeds statistical P80 arrival date\n- 'On Track': Shipment progressing normally within expected timeframes\n- 'Early Arrival': Arrived earlier than P50 estimate\n\nFILTERING:\n- company_id (REQUIRED): Company owning the shipments\n- search: Search by shipment name or ref number (partial match, searches both fields) - NOTE: disables terminal status filter\n- ref_number: Find specific shipment by exact reference number - NOTE: disables terminal status filter\n- signal: Filter by actionable alert type (Ghost Shipment, Delayed, etc.)\n- shipment_type: Filter by logistics model type (REGULAR, FBA INBOUND, AWD INBOUND)\n- include_received: Show received shipments (default: false)\n- include_terminal_status: Show CLOSED/CANCELLED/DELETED/ERROR shipments (default: false)\n- destination_warehouse_name: Find shipments to specific warehouse (partial match)\n- original_warehouse_name: Find shipments from specific origin (partial match)\n- delay_threshold_days: Show only shipments delayed by X+ days beyond P80\n- min_days_in_transit: Show only shipments in transit for X+ days\n- shipped_after/shipped_before: Date range for ship date\n- eta_before: Find shipments expected to arrive by specific date\n\nROUTE AGGREGATION MODE (aggregate_by_route=true):\nReturns route-level performance metrics:\n- avg_days_in_transit, median_days_in_transit\n- reliability_pct: % of shipments arriving within P80\n- delayed_count, ghost_shipment_count per route\n\nEXAMPLE USE CASES:\n\n1. Find ghost shipments (highest priority):\n   - filters: {company_id: 103, signal: ['Ghost Shipment']}\n   - Returns shipments that need ledger reconciliation\n\n2. Find delayed FBA shipments:\n   - filters: {company_id: 103, shipment_type: ['FBA INBOUND'], signal: ['Delayed']}\n   - sort: {field: 'urgency_score', direction: 'desc'}\n\n3. Capacity planning - what arrives this week:\n   - filters: {company_id: 103, eta_before: '2026-02-10'}\n   - sort: {field: 'tracked_eta', direction: 'asc'}\n\n4. Analyze route performance:\n   - filters: {company_id: 103, shipped_after: '2025-11-01'}\n   - aggregate_by_route: true\n   - Identify problematic shipping lanes\n\n5. Find shipments from China in last 30 days:\n   - filters: {company_id: 103, origin_country_code: ['CN'], shipped_after: '2026-01-04'}\n\n6. Search for a specific shipment by name or reference:\n   - filters: {company_id: 103, search: 'PO-12345'}\n   - Searches both shipment_name and ref_number (partial match)\n   - NOTE: Automatically includes all statuses to find the shipment\n\n7. Look up exact shipment by reference number:\n   - filters: {company_id: 103, ref_number: 'PO-12345', include_received: true}\n   - Use include_received: true to find shipments regardless of arrival status\n\n8. View all historical shipments including closed/cancelled:\n   - filters: {company_id: 103, include_terminal_status: true, include_received: true, shipped_after: '2025-01-01'}\n   - Shows complete shipment history\n\nOUTPUT (Shipment Mode):\n- summary: totals, action_required breakdown, by_destination grouping\n- shipments[]: detailed shipment info including urgency_score, has_historical_data\n\nOUTPUT (Route Aggregation Mode):\n- summary: total_routes, routes_with_delays, routes_with_ghost_shipments\n- routes[]: aggregated performance by origin→destination\n\nInput uses the standard query envelope:\n- query.filters: WHERE clause conditions\n- query.sort: ORDER BY field and direction\n- query.limit: Maximum rows to return (default: 50)\n- query.aggregate_by_route: Enable route aggregation mode",
  "isConsequential": false,
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "object",
        "description": "Standard query envelope for shipment monitoring",
        "required": ["filters"],
        "properties": {
          "filters": {
            "type": "object",
            "description": "WHERE clause filters. company_id is required.",
            "required": ["company_id"],
            "properties": {
              "company_id": {
                "type": "integer",
                "minimum": 1,
                "description": "Company identifier - required for multi-tenant isolation"
              },
              "signal": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["Ghost Shipment", "Delayed", "On Track", "Early Arrival"]
                },
                "description": "Filter by actionable alert type. Most common: ['Ghost Shipment'] for ledger issues, ['Delayed'] for late shipments"
              },
              "shipment_type": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["REGULAR", "FBA INBOUND", "AWD INBOUND"]
                },
                "description": "Filter by logistics model type(s): REGULAR (warehouse-to-warehouse), FBA INBOUND (to Amazon FBA), AWD INBOUND (to Amazon AWD)"
              },
              "destination_warehouse_name": {
                "type": "string",
                "description": "Filter shipments to specific destination warehouse (supports partial match, e.g., 'LGB8')"
              },
              "original_warehouse_name": {
                "type": "string",
                "description": "Filter shipments from specific origin warehouse"
              },
              "delay_threshold_days": {
                "type": "integer",
                "minimum": 0,
                "description": "Show only shipments where tracked_eta exceeds p80_eta by this many days"
              },
              "min_days_in_transit": {
                "type": "integer",
                "minimum": 1,
                "description": "Show only shipments in transit for at least this many days"
              },
              "origin_country_code": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by origin country code(s) - e.g., ['US', 'CN']"
              },
              "destination_country_code": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by destination country code(s) - e.g., ['US', 'UK']"
              },
              "include_received": {
                "type": "boolean",
                "default": false,
                "description": "Include shipments already received (arrived_at is not NULL). Default false = in-transit only."
              },
              "include_terminal_status": {
                "type": "boolean",
                "default": false,
                "description": "Include shipments with terminal status (CLOSED, CANCELLED, DELETED, ERROR). By default these are excluded. Set to true to see all shipments including completed/cancelled ones."
              },
              "shipped_after": {
                "type": "string",
                "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
                "description": "Show shipments shipped on or after this date (YYYY-MM-DD format)"
              },
              "shipped_before": {
                "type": "string",
                "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
                "description": "Show shipments shipped on or before this date (YYYY-MM-DD format)"
              },
              "eta_before": {
                "type": "string",
                "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
                "description": "Show shipments with tracked_eta on or before this date - useful for capacity planning"
              },
              "search": {
                "type": "string",
                "description": "Search shipments by name or reference number (partial match). Searches both shipment_name and ref_number fields. Example: 'CHINA' or 'PO-123'"
              },
              "ref_number": {
                "type": "string",
                "description": "Find a specific shipment by exact reference number. Use this when you know the exact ref_number."
              }
            },
            "additionalProperties": false
          },
          "sort": {
            "type": "object",
            "description": "Sort results by any output field",
            "properties": {
              "field": {
                "type": "string",
                "enum": ["delay_days", "days_in_transit", "tracked_eta", "p80_eta", "date_shipped", "shipment_name", "urgency_score"],
                "default": "delay_days",
                "description": "Field to sort by. Use 'urgency_score' for priority-based ordering"
              },
              "direction": {
                "type": "string",
                "enum": ["asc", "desc"],
                "default": "desc",
                "description": "Sort direction"
              }
            },
            "additionalProperties": false
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 500,
            "default": 50,
            "description": "Maximum number of shipments to return"
          },
          "aggregate_by_route": {
            "type": "boolean",
            "default": false,
            "description": "Enable route aggregation mode. Returns performance metrics grouped by origin→destination warehouse pairs instead of individual shipments."
          }
        },
        "additionalProperties": false
      }
    },
    "required": ["query"],
    "additionalProperties": false
  },
  "outputSchema": {
    "type": "object",
    "description": "Response structure depends on aggregate_by_route setting",
    "properties": {
      "mode": {
        "type": "string",
        "enum": ["shipment", "route_aggregation"],
        "description": "Indicates which response mode was used"
      },
      "summary": {
        "type": "object",
        "description": "Summary statistics for the query results",
        "properties": {
          "total_shipments": { "type": "integer" },
          "in_transit_count": { "type": "integer" },
          "delayed_count": { "type": "integer" },
          "ghost_shipment_count": { "type": "integer" },
          "action_required": {
            "type": "object",
            "properties": {
              "ghost_shipments": { "type": "integer", "description": "Arrived but not received in ledger" },
              "severely_delayed": { "type": "integer", "description": "Delayed by 7+ days" },
              "stuck_in_transit": { "type": "integer", "description": "In transit 45+ days" }
            }
          },
          "by_destination": {
            "type": "object",
            "additionalProperties": { "type": "integer" },
            "description": "Count of shipments grouped by destination warehouse"
          }
        }
      },
      "shipments": {
        "type": "array",
        "description": "Individual shipment details (shipment mode only)",
        "items": {
          "type": "object",
          "properties": {
            "shipment_id": { "type": "string" },
            "shipment_name": { "type": "string" },
            "ref_number": { "type": "string" },
            "shipment_type": { "type": "string" },
            "route": {
              "type": "object",
              "properties": {
                "origin": { "type": "string" },
                "origin_country": { "type": "string" },
                "destination": { "type": "string" },
                "destination_country": { "type": "string" }
              }
            },
            "timing": {
              "type": "object",
              "properties": {
                "date_shipped": { "type": "string" },
                "days_in_transit": { "type": "integer" },
                "tracked_eta": { "type": "string" },
                "first_tracked_eta": { "type": "string" }
              }
            },
            "statistical_etas": {
              "type": "object",
              "properties": {
                "p50_eta": { "type": "string" },
                "p80_eta": { "type": "string" },
                "p95_eta": { "type": "string" },
                "delay_days": { "type": "integer" },
                "has_historical_data": { "type": "boolean", "description": "TRUE if route has historical performance data" }
              }
            },
            "urgency_score": { "type": "integer", "minimum": 0, "maximum": 100, "description": "Priority score: 100=ghost, 50-99=severe, 0-49=normal" },
            "status": {
              "type": "object",
              "properties": {
                "signals": { "type": "string" },
                "arrived_at": { "type": "string" },
                "total_items_received": { "type": "integer" }
              }
            },
            "tracking": { "type": "object", "description": "Parsed tracking events JSON" }
          }
        }
      },
      "routes": {
        "type": "array",
        "description": "Route-level performance metrics (route aggregation mode only)",
        "items": {
          "type": "object",
          "properties": {
            "origin_warehouse": { "type": "string" },
            "destination_warehouse": { "type": "string" },
            "origin_country": { "type": "string" },
            "destination_country": { "type": "string" },
            "shipment_counts": {
              "type": "object",
              "properties": {
                "total": { "type": "integer" },
                "in_transit": { "type": "integer" },
                "completed": { "type": "integer" }
              }
            },
            "transit_time_days": {
              "type": "object",
              "properties": {
                "avg": { "type": "number" },
                "median": { "type": "number" },
                "max": { "type": "integer" }
              }
            },
            "performance": {
              "type": "object",
              "properties": {
                "avg_delay_days": { "type": "number" },
                "reliability_pct": { "type": "number", "description": "% of shipments arriving within P80 estimate" },
                "delayed_count": { "type": "integer" },
                "ghost_shipment_count": { "type": "integer" }
              }
            },
            "historical_data": {
              "type": "object",
              "properties": {
                "latest_p50_eta": { "type": "string" },
                "latest_p80_eta": { "type": "string" },
                "latest_p95_eta": { "type": "string" }
              }
            }
          }
        }
      }
    }
  }
}