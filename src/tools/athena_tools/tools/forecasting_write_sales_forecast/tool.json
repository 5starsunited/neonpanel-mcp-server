{
  "name": "forecasting_write_sales_forecast",
  "description": "Write user/AI-adjusted sales forecast values into an Iceberg table for auditability and downstream planning. Consequential (writes data).\n\nUse cases:\n- Persist manual overrides to a forecast for specific item(s) and period(s)\n- Persist AI-recommended adjustments with an explainable reason\n\nSafety / audit:\n- Always include company_id and an explicit item selector (inventory_id or sku+marketplace)\n- Always include a reason and an author/source\n- Prefer dry_run=true for validation before writing\n\nAuthor (important):\n- If author.type=ai, author.name MUST be provided. Ask the user what name to record for audit (e.g., their name or team).\n\nSales amount (required):\n- sales_amount is REQUIRED for each write. Derive it as: sales_amount = units_sold * unit_price.\n- If unit_price is unknown, either (a) compute it from the latest existing forecast (sales_amount / units_sold) for the same SKU+marketplace, or (b) ask the user to provide an assumed unit price.\n\nScenario handling:\n- dataset is always written as \"manual\".\n- scenario_uuid is REQUIRED and should contain the user-provided scenario name (slug). It is used for idempotency in replace mode.\n- Allowed format: lowercase letters, numbers, hyphen, underscore. Length 1–64 (regex: ^[a-z0-9][a-z0-9_-]{0,63}$).\n\nImportant (company selection):\n- Use company_id (preferred) or query.filters.company (numeric string). Do NOT pass a freeform company name.\n\nMarketplace input note:\n- marketplace accepts a country code like US/UK (preferred) and will be mapped to the correct amazon_marketplace_id when writing.\n\nExample (dry run, inventory_id only):\n{\n  \"company_id\": 103,\n  \"reason\": \"Velocity adjustment based on recent sales\",\n  \"author\": { \"type\": \"ai\", \"name\": \"Kio\" },\n  \"dry_run\": true,\n  \"writes\": [\n    { \"inventory_id\": 29972, \"scenario_uuid\": \"override\", \"forecast_period\": \"2026-01\", \"units_sold\": 151, \"sales_amount\": 1234.56, \"currency\": \"USD\" }\n  ]\n}\n\nExample (dry run, sku + marketplace):\n{\n  \"company_id\": 103,\n  \"reason\": \"Promo uplift adjustment for Q1\",\n  \"author\": { \"type\": \"ai\", \"name\": \"Kio\" },\n  \"dry_run\": true,\n  \"writes\": [\n    {\n      \"sku\": \"KEM-ASC-LG-BL1520-XL\",\n      \"marketplace\": \"US\",\n      \"scenario_uuid\": \"override\",\n      \"forecast_period\": \"2026-01\",\n      \"units_sold\": 151,\n      \"sales_amount\": 1234.56,\n      \"currency\": \"USD\"\n    }\n  ]\n}",
  "isConsequential": true,
  "inputSchema": {
    "type": "object",
    "properties": {
      "company_id": {
        "type": "integer",
        "minimum": 1,
        "description": "Company id the write applies to. Must be authorized."
      },
      "author": {
        "type": "object",
        "description": "Who/what is making this change (for audit). If type='ai', name MUST be provided (ask the user for their name or team).",
        "properties": {
          "type": { "type": "string", "enum": ["user", "ai", "system"], "default": "user" },
          "name": { "type": "string", "description": "Display name or agent name. Required when type='ai'." },
          "id": { "type": "string", "description": "Optional stable identifier for the actor (user id / agent id)." }
        },
        "required": ["type"],
        "additionalProperties": false
      },
      "reason": {
        "type": "string",
        "minLength": 10,
        "description": "Human-readable reason for the adjustment (stored for audit). Be specific (minimum 10 characters)."
      },
      "dry_run": {
        "type": "boolean",
        "default": true,
        "description": "If true, validate and preview writes without persisting."
      },
      "write_mode": {
        "type": "string",
        "enum": ["append", "replace"],
        "default": "append",
        "description": "append (default) inserts new rows; replace deletes existing rows for the same inventory_id (or sku+marketplace) + forecast_period + scenario_uuid before inserting."
      },
      "idempotency_key": {
        "type": "string",
        "description": "Optional idempotency key to prevent duplicate writes on retries."
      },
      "debug_sql": {
        "type": "boolean",
        "default": false,
        "description": "If true during dry_run, include rendered Athena SQL in meta.debug for troubleshooting. (Ignored when dry_run=false.)"
      },
      "writes": {
        "type": "array",
        "minItems": 1,
        "maxItems": 500,
        "description": "One or more forecast write operations (period-level).",
        "items": {
          "type": "object",
          "properties": {
            "inventory_id": {
              "type": "integer",
              "minimum": 1,
              "description": "Preferred item selector."
            },
            "sku": {
              "type": "string",
              "description": "Alternative item selector when inventory_id is not available."
            },
            "marketplace": {
              "type": "string",
              "description": "Marketplace for SKU-based writes (e.g., US/UK or amazon marketplace id)."
            },

            "scenario_uuid": {
              "type": "string",
              "pattern": "^[a-z0-9][a-z0-9_-]{0,63}$",
              "description": "REQUIRED. Scenario identifier (slug). Stored in scenario_uuid and treated as the scenario name. Lowercase letters/numbers plus '-' or '_', 1–64 chars."
            },

            "forecast_period": {
              "type": "string",
              "pattern": "^\\d{4}-\\d{2}$",
              "description": "Forecast period key in YYYY-MM format (e.g., 2026-01)."
            },

            "units_sold": {
              "type": "number",
              "minimum": 0,
              "description": "Adjusted forecast units for the period."
            },
            "sales_amount": {
              "type": "number",
              "minimum": 0,
              "description": "Required adjusted revenue for the period. Derive as units_sold * unit_price."
            },
            "currency": {
              "type": "string",
              "minLength": 3,
              "maxLength": 3,
              "description": "Required currency code for sales_amount (e.g., USD, GBP, EUR)."
            },

            "note": {
              "type": "string",
              "description": "Optional per-write note (e.g., promo, stockout, seasonality adjustment)."
            }
          },
          "required": ["scenario_uuid", "forecast_period", "units_sold", "sales_amount", "currency"],
          "additionalProperties": false,
          "anyOf": [
            { "type": "object", "required": ["inventory_id"] },
            { "type": "object", "required": ["sku", "marketplace"] }
          ]
        }
      }
    },
    "required": ["company_id", "reason", "writes"],
    "additionalProperties": false
  },
  "outputSchema": {
    "type": "object",
    "properties": {
      "dry_run": { "type": "boolean" },
      "accepted": { "type": "integer", "description": "Count of writes accepted for processing." },
      "written": { "type": "integer", "description": "Count of rows actually written (0 in dry-run)." },
      "items": {
        "type": "array",
        "description": "Per-write results (success/error) for transparency.",
        "items": {
          "type": "object",
          "properties": {
            "status": { "type": "string", "enum": ["ok", "skipped", "error"] },
            "inventory_id": { "type": "integer" },
            "sku": { "type": "string" },
            "marketplace": { "type": "string" },
            "forecast_period": { "type": "string" },
            "scenario": { "type": "object", "additionalProperties": true },
            "message": { "type": "string" }
          },
          "additionalProperties": true
        }
      },
      "meta": {
        "type": "object",
        "properties": {
          "warnings": { "type": "array", "items": { "type": "string" } }
        },
        "additionalProperties": true
      }
    },
    "required": ["dry_run", "accepted", "written"],
    "additionalProperties": true
  }
}
