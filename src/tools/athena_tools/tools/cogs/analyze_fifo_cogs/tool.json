{
  "name": "cogs_analyze_fifo_cogs",
  "description": "Analyze FIFO (First-In-First-Out) Cost of Goods Sold from invoice transactions.\n\nThis tool provides flexible COGS analysis with:\n- Time aggregation: monthly, annual, or total period\n- Multiple grouping dimensions: SKU, brand, product family, ASIN, marketplace, etc.\n- Comprehensive filtering by product attributes, geography, and classifications\n- Sign-corrected amounts (invoice quantities are negative, amounts are reversed for proper COGS calculation)\n- Data quality metrics: track missing costs and estimate lost COGS\n- **Transaction-level detail**: Use detail_level='transactions' to see individual records\n\nDATA SOURCE:\n- Table: neonpanel_iceberg.fifo_transactions_snapshot\n- Filter: document_type = 'Invoice' (sales transactions only)\n- COGS Calculation: ABS(transaction_amount) - absolute value to convert negative invoice amounts to positive COGS\n- Transactions: Each row represents a unit sold from a specific inventory batch (FIFO cost assignment)\n\nQUERY MODES:\n\n1. AGGREGATED MODE (default):\n   Use for summary reports with GROUP BY dimensions.\n   Example: {filters: {company_id: [92], detail_level: 'aggregated'}, aggregation: {group_by: ['brand']}}\n\n2. TRANSACTION MODE:\n   Use for investigating specific transactions, batches, or data quality issues.\n   Example: {filters: {company_id: [92], inventory_id: [38423], batch_id: [38967], start_date: '2025-11-01', end_date: '2025-11-30', detail_level: 'transactions'}, limit: 50}\n   Returns: transaction_id, document_date, sku, batch_id, inventory_id, warehouse, costs, etc.\n\n3. DATA QUALITY MODES:\n   - analysis_mode: 'lost_batches' - Transactions without batch assignment\n   - analysis_mode: 'lost_cogs' - Transactions with batch but zero cost\n   Combine with detail_level: 'transactions' to see specific problematic records.\n\nTIME FILTERING:\nDate filters can be specified in two ways (filters take precedence):\n- filters.start_date / filters.end_date - Simple, works with any mode\n- aggregation.time.start_date / aggregation.time.end_date - For time-grouped aggregations\n\nGROUPING DIMENSIONS (query.aggregation.group_by):\nSupported dimensions (order matters for hierarchical grouping):\n- 'sku': SKU identifier\n- 'brand': Brand name\n- 'product_family': Product family/category\n- 'child_asin': Child ASIN (variation)\n- 'parent_asin': Parent ASIN (product group)\n- 'marketplace': Marketplace name (e.g., Amazon.com, Amazon.ca)\n- 'country': Country name (e.g., United States, Canada)\n- 'marketplace_currency': Currency code (e.g., USD, CAD)\n- 'revenue_abcd_class': Revenue classification (A=top 70%, B=next 20%, C=next 8%, D=bottom 2%)\n- 'pareto_abc_class': Pareto classification (A=top 80%, B=next 15%, C=bottom 5%)\n- 'inventory_id': Specific inventory item ID\n- 'batch_id': Batch document ID\n- 'vendor': Supplier/vendor name\n\nOUTPUT METRICS:\n- cogs_amount: Total cost of goods sold (sum of item_landed_cost Ã— quantity, sign-corrected)\n- units_sold: Total units sold (absolute value of quantity)\n- units_with_cost: Units that have cost data (item_landed_cost > 0)\n- units_missing_cost: Units sold without cost data (item_landed_cost = 0 or NULL)\n- cogs_quality_pct: Data quality percentage (units_with_cost Ã· units_sold Ã— 100)\n- cogs_quality_status: Visual indicator - ðŸ”´ Red: <90% (critical), ðŸŸ¡ Yellow: 90-98.99% (warning), ðŸŸ¢ Green: â‰¥99% (excellent)\n- estimated_lost_cogs: Estimated missing COGS (avg_unit_cogs Ã— units_missing_cost)\n- transactions_count: Number of invoice transactions\n- avg_unit_cogs: Average COGS per unit (cogs_amount Ã· units_sold)\n- purchase_price_amount: Total purchase price component (sum of item_purchase_price Ã— quantity)\n\nEXAMPLE USE CASES:\n\n1. Get 20 transactions for a specific batch:\n   - filters: {company_id: [92], inventory_id: [38423], batch_id: [38967], start_date: '2025-11-01', detail_level: 'transactions'}\n   - limit: 20\n\n2. Find transactions with missing costs:\n   - filters: {company_id: [92], analysis_mode: 'lost_cogs', detail_level: 'transactions'}\n   - limit: 50\n\n3. Monthly COGS by brand:\n   - filters: {company_id: [103]}\n   - aggregation: {group_by: ['brand'], time: {periodicity: 'month', start_date: '2024-01-01', end_date: '2024-12-31'}}\n\n4. Quality check - brands with missing cost data:\n   - filters: {company_id: [103]}\n   - aggregation: {group_by: ['brand']}\n   - sort: {field: 'cogs_quality_pct', direction: 'asc'}\n\nIMPORTANT NOTES:\n- company_id filter is REQUIRED (multi-tenant data)\n- detail_level='transactions' ignores aggregation.group_by and returns individual records\n- All filters work with both aggregated and transaction modes\n- Results sorted by cogs_amount DESC by default",
  "isConsequential": false,
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "object",
        "description": "Standard query envelope for COGS analysis",
        "required": ["filters"],
        "properties": {
          "filters": {
            "type": "object",
            "description": "WHERE clause filters. company_id is required.",
            "required": ["company_id"],
            "properties": {
              "company_id": {
                "type": "array",
                "items": { "type": "integer", "minimum": 1 },
                "minItems": 1,
                "description": "Company identifier(s) - required for multi-tenant isolation. Single company: [103], Portfolio analysis: [103, 104, 105]. Note: Multiple companies = larger data scans."
              },
              "sku": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by SKU(s)"
              },
              "brand": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by brand(s)"
              },
              "product_family": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by product family/category"
              },
              "child_asin": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by child ASIN(s)"
              },
              "parent_asin": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by parent ASIN(s)"
              },
              "marketplace": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by marketplace(s) - e.g., ['Amazon.com', 'Amazon.ca']"
              },
              "country": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by country name(s) - e.g., ['United States', 'Canada']"
              },
              "marketplace_currency": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by currency code(s) - e.g., ['USD', 'CAD']"
              },
              "revenue_abcd_class": {
                "type": "array",
                "items": { "type": "string", "enum": ["A", "B", "C", "D"] },
                "description": "Filter by revenue classification (A=top 70%, B=next 20%, C=next 8%, D=bottom 2%)"
              },
              "pareto_abc_class": {
                "type": "array",
                "items": { "type": "string", "enum": ["A", "B", "C"] },
                "description": "Filter by Pareto classification (A=top 80%, B=next 15%, C=bottom 5%)"
              },
              "inventory_id": {
                "type": "array",
                "items": { "type": "integer" },
                "description": "Filter by specific inventory item ID(s)"
              },
              "vendor": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by supplier/vendor name(s)"
              },
              "document_id": {
                "type": "array",
                "items": { "type": "integer" },
                "description": "Filter by invoice document ID(s) - numeric IDs"
              },
              "document_ref_number": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by invoice reference number(s) - e.g., ['22431653901-12-AUS']"
              },
              "transaction_id": {
                "type": "array",
                "items": { "type": "integer" },
                "description": "Filter by FIFO transaction ID(s) - numeric IDs"
              },
              "source_batch_id": {
                "type": "array",
                "items": { "type": "integer" },
                "description": "Filter by source batch ID(s) - IO/AO batch where inventory originated. Matches both io_batch_id and ao_batch_id."
              },
              "batch_id": {
                "type": "array",
                "items": { "type": "integer" },
                "description": "Filter by batch document ID(s) - final batch with added costs (e.g., FBA shipment)"
              },
              "origin_warehouse": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by origin warehouse name(s) - where inventory came from"
              },
              "destination_warehouse": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Filter by destination warehouse name(s) - where inventory went to"
              },
              "search": {
                "type": "string",
                "description": "Partial text search across all name/ref fields (SKU, brand, product_family, vendor, batch names, warehouse names, etc.). Case-insensitive LIKE search."
              },
              "analysis_mode": {
                "type": "string",
                "enum": ["normal", "lost_batches", "lost_cogs"],
                "default": "normal",
                "description": "Analysis mode for data quality views:\n- 'normal' (default): All transactions - standard COGS analysis with quality metrics\n- 'lost_batches': Only transactions where batch_document_id IS NULL (items without batch assignment - data quality issue)\n- 'lost_cogs': Only transactions where batch exists but item_landed_cost = 0 (batches without costs entered)"
              },
              "detail_level": {
                "type": "string",
                "enum": ["aggregated", "transactions"],
                "default": "aggregated",
                "description": "Output detail level:\n- 'aggregated' (default): Group by dimensions, return summary metrics (cogs_amount, units_sold, quality %)\n- 'transactions': Return individual transaction rows with full details (transaction_id, document_date, SKU, batch, warehouse, etc.). Use 'transactions' when you need to see specific problematic records, especially with analysis_mode='lost_batches' or 'lost_cogs'."
              },
              "start_date": {
                "type": "string",
                "format": "date",
                "description": "Start date filter (inclusive) - format: YYYY-MM-DD. Can be used directly in filters (simpler) or in aggregation.time. Filters.start_date takes precedence."
              },
              "end_date": {
                "type": "string",
                "format": "date",
                "description": "End date filter (inclusive) - format: YYYY-MM-DD. Can be used directly in filters (simpler) or in aggregation.time. Filters.end_date takes precedence."
              }
            },
            "additionalProperties": false
          },
          "aggregation": {
            "type": "object",
            "description": "GROUP BY dimensions and time bucketing",
            "properties": {
              "group_by": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": [
                    "sku",
                    "brand",
                    "product_family",
                    "child_asin",
                    "parent_asin",
                    "marketplace",
                    "country",
                    "marketplace_currency",
                    "revenue_abcd_class",
                    "pareto_abc_class",
                    "inventory_id",
                    "source_batch_id",
                    "batch_id",
                    "batch",
                    "batch_ref_number",
                    "vendor",
                    "document_id",
                    "document_ref_number",
                    "origin_warehouse",
                    "destination_warehouse",
                    "transaction_id"
                  ]
                },
                "description": "Dimensions to group by. Order matters for hierarchical grouping. Empty array = aggregate all matching records.",
                "default": []
              },
              "time": {
                "type": "object",
                "description": "Time bucketing and date range filtering",
                "properties": {
                  "periodicity": {
                    "type": "string",
                    "enum": ["month", "year", "total"],
                    "default": "total",
                    "description": "'month' = YYYY-MM grouping, 'year' = YYYY grouping, 'total' = no time grouping"
                  },
                  "start_date": {
                    "type": "string",
                    "format": "date",
                    "description": "Start date filter (inclusive) - format: YYYY-MM-DD"
                  },
                  "end_date": {
                    "type": "string",
                    "format": "date",
                    "description": "End date filter (inclusive) - format: YYYY-MM-DD"
                  }
                },
                "additionalProperties": false
              }
            },
            "additionalProperties": false
          },
          "sort": {
            "type": "object",
            "description": "Sort order for results",
            "properties": {
              "field": {
                "type": "string",
                "enum": [
                  "cogs_amount",
                  "units_sold",
                  "units_with_cost",
                  "units_missing_cost",
                  "cogs_quality_pct",
                  "estimated_lost_cogs",
                  "transactions_count",
                  "avg_unit_cogs",
                  "purchase_price_amount",
                  "time_period",
                  "document_date",
                  "transaction_id"
                ],
                "default": "cogs_amount",
                "description": "Field to sort by"
              },
              "direction": {
                "type": "string",
                "enum": ["asc", "desc"],
                "default": "desc",
                "description": "Sort direction"
              }
            },
            "additionalProperties": false
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 10000,
            "default": 100,
            "description": "Maximum number of rows to return"
          }
        },
        "additionalProperties": false
      }
    },
    "required": ["query"],
    "additionalProperties": false
  }
}
